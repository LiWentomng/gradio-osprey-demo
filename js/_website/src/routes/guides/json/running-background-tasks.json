{"guide": {"name": "running-background-tasks", "category": "other-tutorials", "pretty_category": "Other Tutorials", "guide_index": null, "absolute_index": 39, "pretty_name": "Running Background Tasks", "content": "# Running Background Tasks \n\nRelated spaces: https://huggingface.co/spaces/freddyaboulton/gradio-google-forms\nTags: TASKS, SCHEDULED, TABULAR, DATA \n\n## Introduction\n\nThis guide explains how you can run background tasks from your gradio app.\nBackground tasks are operations that you'd like to perform outside the request-response\nlifecycle of your app either once or on a periodic schedule.\nExamples of background tasks include periodically synchronizing data to an external database or \nsending a report of model predictions via email.\n\n## Overview \n    \nWe will be creating a simple \"Google-forms-style\" application to gather feedback from users of the gradio library.\nWe will use a local sqlite database to store our data, but we will periodically synchronize the state of the database\nwith a [HuggingFace Dataset](https://huggingface.co/datasets) so that our user reviews are always backed up.\nThe synchronization will happen in a background task running every 60 seconds.\n\nAt the end of the demo, you'll have a fully working application like this one:\n\n<gradio-app space=\"freddyaboulton/gradio-google-forms\"> </gradio-app>\n\n\n## Step 1 - Write your database logic \ud83d\udcbe\nOur application will store the name of the reviewer, their rating of gradio on a scale of 1 to 5, as well as\nany comments they want to share about the library. Let's write some code that creates a database table to\nstore this data. We'll also write some functions to insert a review into that table and fetch the latest 10 reviews.\n\nWe're going to use the `sqlite3` library to connect to our sqlite database but gradio will work with any library.\n\nThe code will look like this:\n\n```python\nDB_FILE = \"./reviews.db\"\ndb = sqlite3.connect(DB_FILE)\n\n# Create table if it doesn't already exist\ntry:\n    db.execute(\"SELECT * FROM reviews\").fetchall()\n    db.close()\nexcept sqlite3.OperationalError:\n    db.execute(\n        '''\n        CREATE TABLE reviews (id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,\n                              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,\n                              name TEXT, review INTEGER, comments TEXT)\n        ''')\n    db.commit()\n    db.close()\n\ndef get_latest_reviews(db: sqlite3.Connection):\n    reviews = db.execute(\"SELECT * FROM reviews ORDER BY id DESC limit 10\").fetchall()\n    total_reviews = db.execute(\"Select COUNT(id) from reviews\").fetchone()[0]\n    reviews = pd.DataFrame(reviews, columns=[\"id\", \"date_created\", \"name\", \"review\", \"comments\"])\n    return reviews, total_reviews\n\n\ndef add_review(name: str, review: int, comments: str):\n    db = sqlite3.connect(DB_FILE)\n    cursor = db.cursor()\n    cursor.execute(\"INSERT INTO reviews(name, review, comments) VALUES(?,?,?)\", [name, review, comments])\n    db.commit()\n    reviews, total_reviews = get_latest_reviews(db)\n    db.close()\n    return reviews, total_reviews\n```\n\nLet's also write a function to load the latest reviews when the gradio application loads:\n```python\ndef load_data():\n    db = sqlite3.connect(DB_FILE)\n    reviews, total_reviews = get_latest_reviews(db)\n    db.close()\n    return reviews, total_reviews\n```\n\n## Step 2 - Create a gradio app \u26a1\nNow that we have our database logic defined, we can use gradio create a dynamic web page to ask our users for feedback! \n\n```python\nwith gr.Blocks() as demo:\n    with gr.Row():\n        with gr.Column():\n            name = gr.Textbox(label=\"Name\", placeholder=\"What is your name?\")\n            review = gr.Radio(label=\"How satisfied are you with using gradio?\", choices=[1, 2, 3, 4, 5])\n            comments = gr.Textbox(label=\"Comments\", lines=10, placeholder=\"Do you have any feedback on gradio?\")\n            submit = gr.Button(value=\"Submit Feedback\")\n        with gr.Column():\n            data = gr.Dataframe(label=\"Most recently created 10 rows\")\n            count = gr.Number(label=\"Total number of reviews\")\n    submit.click(add_review, [name, review, comments], [data, count])\n    demo.load(load_data, None, [data, count])\n```\n\n## Step 3 - Synchronize with HuggingFace Datasets \ud83e\udd17\n\nWe could call `demo.launch()` after step 2 and have a fully functioning application. However,\nour data would be stored locally on our machine. If the sqlite file were accidentally deleted, we'd lose all of our reviews!\nLet's back up our data to a dataset on the HuggingFace hub.\n\nCreate a dataset [here](https://huggingface.co/datasets) before proceeding.\n\nNow at the **top** of our script, we'll use the [huggingface hub client library](https://huggingface.co/docs/huggingface_hub/index)\nto connect to our dataset and pull the latest backup.\n\n```python\nTOKEN = os.environ.get('HUB_TOKEN')\nrepo = huggingface_hub.Repository(\n    local_dir=\"data\",\n    repo_type=\"dataset\",\n    clone_from=\"<name-of-your-dataset>\",\n    use_auth_token=TOKEN\n)\nrepo.git_pull()\n\nshutil.copyfile(\"./data/reviews.db\", DB_FILE)\n```\n\nNote that you'll have to get an access token from the \"Settings\" tab of your HuggingFace for the above code to work.\nIn the script, the token is securely accessed via an environment variable.\n\n![access_token](https://github.com/gradio-app/gradio/blob/main/guides/assets/access_token.png?raw=true)\n\nNow we will create a background task to synch our local database to the dataset hub every 60 seconds.\nWe will use the [AdvancedPythonScheduler](https://apscheduler.readthedocs.io/en/3.x/) to handle the scheduling.\nHowever, this is not the only task scheduling library available. Feel free to use whatever you are comfortable with.\n\nThe function to back up our data will look like this:\n\n```python\nfrom apscheduler.schedulers.background import BackgroundScheduler\n\ndef backup_db():\n    shutil.copyfile(DB_FILE, \"./data/reviews.db\")\n    db = sqlite3.connect(DB_FILE)\n    reviews = db.execute(\"SELECT * FROM reviews\").fetchall()\n    pd.DataFrame(reviews).to_csv(\"./data/reviews.csv\", index=False)\n    print(\"updating db\")\n    repo.push_to_hub(blocking=False, commit_message=f\"Updating data at {datetime.datetime.now()}\")\n\n\nscheduler = BackgroundScheduler()\nscheduler.add_job(func=backup_db, trigger=\"interval\", seconds=60)\nscheduler.start()\n```\n\n\n## Step 4 (Bonus) - Deployment to HuggingFace Spaces\nYou can use the HuggingFace [Spaces](https://huggingface.co/spaces) platform to deploy this application for free \u2728\n\nIf you haven't used Spaces before, follow the previous guide [here](/using_hugging_face_integrations).\nYou will have to use the `HUB_TOKEN` environment variable as a secret in the Guides.\n\n## Conclusion\nCongratulations! You know how to run background tasks from your gradio app on a schedule \u23f2\ufe0f.  \n\nCheckout the application running on Spaces [here](https://huggingface.co/spaces/freddyaboulton/gradio-google-forms).\nThe complete code is [here](https://huggingface.co/spaces/freddyaboulton/gradio-google-forms/blob/main/app.py)", "html": "<h1 id=\"running-background-tasks\">Running Background Tasks</h1>\n\n<h2 id=\"introduction\">Introduction</h2>\n\n<p>This guide explains how you can run background tasks from your gradio app.\nBackground tasks are operations that you'd like to perform outside the request-response\nlifecycle of your app either once or on a periodic schedule.\nExamples of background tasks include periodically synchronizing data to an external database or \nsending a report of model predictions via email.</p>\n\n<h2 id=\"overview\">Overview</h2>\n\n<p>We will be creating a simple \"Google-forms-style\" application to gather feedback from users of the gradio library.\nWe will use a local sqlite database to store our data, but we will periodically synchronize the state of the database\nwith a <a rel=\"noopener\" target=\"_blank\" href=\"https://huggingface.co/datasets\">HuggingFace Dataset</a> so that our user reviews are always backed up.\nThe synchronization will happen in a background task running every 60 seconds.</p>\n\n<p>At the end of the demo, you'll have a fully working application like this one:</p>\n\n<p><gradio-app space=\"freddyaboulton/gradio-google-forms\"> </gradio-app></p>\n\n<h2 id=\"step-1-write-your-database-logic\">Step 1 - Write your database logic \ud83d\udcbe</h2>\n\n<p>Our application will store the name of the reviewer, their rating of gradio on a scale of 1 to 5, as well as\nany comments they want to share about the library. Let's write some code that creates a database table to\nstore this data. We'll also write some functions to insert a review into that table and fetch the latest 10 reviews.</p>\n\n<p>We're going to use the <code>sqlite3</code> library to connect to our sqlite database but gradio will work with any library.</p>\n\n<p>The code will look like this:</p>\n\n<div class='codeblock'><pre><code class='lang-python'>DB_FILE = \"./reviews.db\"\ndb = sqlite3.connect(DB_FILE)\n\n# Create table if it doesn't already exist\ntry:\n    db.execute(\"SELECT * FROM reviews\").fetchall()\n    db.close()\nexcept sqlite3.OperationalError:\n    db.execute(\n        '''\n        CREATE TABLE reviews (id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,\n                              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,\n                              name TEXT, review INTEGER, comments TEXT)\n        ''')\n    db.commit()\n    db.close()\n\ndef get_latest_reviews(db: sqlite3.Connection):\n    reviews = db.execute(\"SELECT * FROM reviews ORDER BY id DESC limit 10\").fetchall()\n    total_reviews = db.execute(\"Select COUNT(id) from reviews\").fetchone()[0]\n    reviews = pd.DataFrame(reviews, columns=[\"id\", \"date_created\", \"name\", \"review\", \"comments\"])\n    return reviews, total_reviews\n\n\ndef add_review(name: str, review: int, comments: str):\n    db = sqlite3.connect(DB_FILE)\n    cursor = db.cursor()\n    cursor.execute(\"INSERT INTO reviews(name, review, comments) VALUES(?,?,?)\", [name, review, comments])\n    db.commit()\n    reviews, total_reviews = get_latest_reviews(db)\n    db.close()\n    return reviews, total_reviews\n</code></pre></div>\n\n<p>Let's also write a function to load the latest reviews when the gradio application loads:</p>\n\n<div class='codeblock'><pre><code class='lang-python'>def load_data():\n    db = sqlite3.connect(DB_FILE)\n    reviews, total_reviews = get_latest_reviews(db)\n    db.close()\n    return reviews, total_reviews\n</code></pre></div>\n\n<h2 id=\"step-2-create-a-gradio-app\">Step 2 - Create a gradio app \u26a1</h2>\n\n<p>Now that we have our database logic defined, we can use gradio create a dynamic web page to ask our users for feedback! </p>\n\n<div class='codeblock'><pre><code class='lang-python'>with gr.Blocks() as demo:\n    with gr.Row():\n        with gr.Column():\n            name = gr.Textbox(label=\"Name\", placeholder=\"What is your name?\")\n            review = gr.Radio(label=\"How satisfied are you with using gradio?\", choices=[1, 2, 3, 4, 5])\n            comments = gr.Textbox(label=\"Comments\", lines=10, placeholder=\"Do you have any feedback on gradio?\")\n            submit = gr.Button(value=\"Submit Feedback\")\n        with gr.Column():\n            data = gr.Dataframe(label=\"Most recently created 10 rows\")\n            count = gr.Number(label=\"Total number of reviews\")\n    submit.click(add_review, [name, review, comments], [data, count])\n    demo.load(load_data, None, [data, count])\n</code></pre></div>\n\n<h2 id=\"step-3-synchronize-with-huggingface-datasets\">Step 3 - Synchronize with HuggingFace Datasets \ud83e\udd17</h2>\n\n<p>We could call <code>demo.launch()</code> after step 2 and have a fully functioning application. However,\nour data would be stored locally on our machine. If the sqlite file were accidentally deleted, we'd lose all of our reviews!\nLet's back up our data to a dataset on the HuggingFace hub.</p>\n\n<p>Create a dataset <a rel=\"noopener\" target=\"_blank\" href=\"https://huggingface.co/datasets\">here</a> before proceeding.</p>\n\n<p>Now at the <strong>top</strong> of our script, we'll use the <a rel=\"noopener\" target=\"_blank\" href=\"https://huggingface.co/docs/huggingface_hub/index\">huggingface hub client library</a>\nto connect to our dataset and pull the latest backup.</p>\n\n<div class='codeblock'><pre><code class='lang-python'>TOKEN = os.environ.get('HUB_TOKEN')\nrepo = huggingface_hub.Repository(\n    local_dir=\"data\",\n    repo_type=\"dataset\",\n    clone_from=\"<name-of-your-dataset>\",\n    use_auth_token=TOKEN\n)\nrepo.git_pull()\n\nshutil.copyfile(\"./data/reviews.db\", DB_FILE)\n</code></pre></div>\n\n<p>Note that you'll have to get an access token from the \"Settings\" tab of your HuggingFace for the above code to work.\nIn the script, the token is securely accessed via an environment variable.</p>\n\n<p><img src=\"https://github.com/gradio-app/gradio/blob/main/guides/assets/access_token.png?raw=true\" alt=\"access_token\" /></p>\n\n<p>Now we will create a background task to synch our local database to the dataset hub every 60 seconds.\nWe will use the <a rel=\"noopener\" target=\"_blank\" href=\"https://apscheduler.readthedocs.io/en/3.x/\">AdvancedPythonScheduler</a> to handle the scheduling.\nHowever, this is not the only task scheduling library available. Feel free to use whatever you are comfortable with.</p>\n\n<p>The function to back up our data will look like this:</p>\n\n<div class='codeblock'><pre><code class='lang-python'>from apscheduler.schedulers.background import BackgroundScheduler\n\ndef backup_db():\n    shutil.copyfile(DB_FILE, \"./data/reviews.db\")\n    db = sqlite3.connect(DB_FILE)\n    reviews = db.execute(\"SELECT * FROM reviews\").fetchall()\n    pd.DataFrame(reviews).to_csv(\"./data/reviews.csv\", index=False)\n    print(\"updating db\")\n    repo.push_to_hub(blocking=False, commit_message=f\"Updating data at {datetime.datetime.now()}\")\n\n\nscheduler = BackgroundScheduler()\nscheduler.add_job(func=backup_db, trigger=\"interval\", seconds=60)\nscheduler.start()\n</code></pre></div>\n\n<h2 id=\"step-4-bonus-deployment-to-huggingface-spaces\">Step 4 (Bonus) - Deployment to HuggingFace Spaces</h2>\n\n<p>You can use the HuggingFace <a rel=\"noopener\" target=\"_blank\" href=\"https://huggingface.co/spaces\">Spaces</a> platform to deploy this application for free \u2728</p>\n\n<p>If you haven't used Spaces before, follow the previous guide <a rel=\"noopener\" target=\"_blank\" href=\"/using_hugging_face_integrations\">here</a>.\nYou will have to use the <code>HUB_TOKEN</code> environment variable as a secret in the Guides.</p>\n\n<h2 id=\"conclusion\">Conclusion</h2>\n\n<p>Congratulations! You know how to run background tasks from your gradio app on a schedule \u23f2\ufe0f.  </p>\n\n<p>Checkout the application running on Spaces <a rel=\"noopener\" target=\"_blank\" href=\"https://huggingface.co/spaces/freddyaboulton/gradio-google-forms\">here</a>.\nThe complete code is <a rel=\"noopener\" target=\"_blank\" href=\"https://huggingface.co/spaces/freddyaboulton/gradio-google-forms/blob/main/app.py\">here</a></p>\n", "tags": ["TASKS", "SCHEDULED", "TABULAR", "DATA "], "spaces": ["https://huggingface.co/spaces/freddyaboulton/gradio-google-forms"], "url": "/guides/running-background-tasks/", "contributor": null}}